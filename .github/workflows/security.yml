name: security-gates
on:
  pull_request:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
concurrency: security-gates-${{ github.ref }}

jobs:
  sast:
    name: SAST gates
    permissions:
      contents: read
      security-events: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }

      - name: Enforce lockfile
        if: hashFiles('package.json') != '' && hashFiles('package-lock.json') == ''
        run: |
          echo "::error::package-lock.json is missing. Run: npm install --package-lock-only"
          exit 1

      - name: npm ci (locked)
        if: hashFiles('package-lock.json') != ''
        run: npm ci --ignore-scripts

      - name: Semgrep (OWASP + custom) > SARIF
        run: |
          python3 -m pip install --upgrade pip
          pip3 install semgrep
          semgrep scan \
            --config p/owasp-top-ten \
            --config ./semgrep.yml \
            --severity ERROR --error --metrics=off \
            --sarif -o semgrep.sarif

      - name: Upload Semgrep SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif

      - name: Gitleaks (SARIF, PR)
        if: github.event_name == 'pull_request'
        run: |
          ver=8.24.3
          curl -sSL https://github.com/zricethezav/gitleaks/releases/download/v${ver}/gitleaks_${ver}_linux_x64.tar.gz -o /tmp/gitleaks.tgz
          tar -xzf /tmp/gitleaks.tgz -C /tmp gitleaks
          install -m 0755 /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks detect --redact --exit-code 2 \
            --report-format sarif --report-path gitleaks.sarif || true

      - name: Upload Gitleaks SARIF (PR)
        if: always() && github.event_name == 'pull_request' && hashFiles('gitleaks.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif

      - name: Gitleaks (repo scan)
        if: github.event_name != 'pull_request'
        run: |
          ver=8.24.3
          curl -sSL https://github.com/zricethezav/gitleaks/releases/download/v${ver}/gitleaks_${ver}_linux_x64.tar.gz -o /tmp/gitleaks.tgz
          tar -xzf /tmp/gitleaks.tgz -C /tmp gitleaks
          install -m 0755 /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks detect --no-git --redact --exit-code 2 --report-format sarif --report-path gitleaks.sarif

      - name: Upload Gitleaks SARIF (repo)
        if: always() && github.event_name != 'pull_request' && hashFiles('gitleaks.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif

      - name: Trivy filesystem
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          skip-dirs: node_modules
          exit-code: '1'

      - name: Upload Trivy SARIF (fs)
        if: always() && hashFiles('trivy-fs.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-fs.sarif

      - name: Syft SBOM
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft . -o json > sbom.json

      - name: Grype on SBOM
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype sbom:sbom.json --fail-on high
      - name: tfsec (Terraform)
        if: hashFiles('**/*.tf') != ''
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          soft_fail: false

      - name: Checkov (Terraform/K8s/CFN)
        if: hashFiles('**/*.tf') != '' || hashFiles('**/*.yml') != '' || hashFiles('**/*.yaml') != ''
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform,kubernetes,cloudformation
          quiet: true
          soft_fail: false
          output_format: sarif
          output_file_path: checkov.sarif

      - name: Upload Checkov SARIF
        if: always() && hashFiles('checkov.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif
  dast:
    name: DAST gates
    runs-on: ubuntu-latest
    needs: sast
    timeout-minutes: 25
    services:
      juice:
        image: bkimminich/juice-shop:latest
        ports: [ "3000:3000" ]
        options: >-
          --health-cmd="curl -fsS http://localhost:3000/ >/dev/null || exit 1"
          --health-interval=5s --health-retries=30
      waf:
        image: owasp/modsecurity-crs:nginx
        env:
          BACKEND: "http://juice:3000"
          SERVER_NAME: "localhost"
          PORT: "8080"
        ports: [ "8080:8080" ]

    steps:
      - uses: actions/checkout@v4

      - name: Wait for WAF
        run: |
          for i in {1..60}; do curl -fsS http://localhost:8080/healthz >/dev/null && exit 0; sleep 2; done
          echo "WAF not healthy" >&2; exit 1

      - name: Inject NGINX template into WAF and reload
        run: |
          WAF_ID=$(docker ps --filter "ancestor=owasp/modsecurity-crs:nginx" --format "{{.ID}}" | head -n1)
          # копируем твой шаблон внутрь
          docker cp nginx/default.conf.template "$WAF_ID":/etc/nginx/templates/default.conf.template
          # генерим конфиг и перегружаем
          docker exec "$WAF_ID" sh -lc 'envsubst < /etc/nginx/templates/default.conf.template > /etc/nginx/conf.d/default.conf && nginx -t && nginx -s reload'

      - name:
          Sanity: headers
        run: |
          curl -sD - -o /dev/null http://localhost:8080 | tr -d '\r' \
          | awk 'BEGIN{IGNORECASE=1} /^Content-Security-Policy|^Access-Control-Allow-Origin|^Vary: Origin|^X-Content-Type-Options/{print}'

      - name: ZAP Baseline against WAF
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: "http://localhost:8080"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-m 3 -d -I"
          fail_action: true
          allow_issue_writing: false
          artifact_name: "zap_baseline"

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap_baseline_reports
          path: |
            report_html.html
            report_md.md
            report_json.json
          retention-days: 14