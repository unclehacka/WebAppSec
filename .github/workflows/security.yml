name: security-gates
on: [push, pull_request]
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/owasp-top-ten

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2

      - name: Trivy filesystem
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'

      - name: Syft SBOM
        run: curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin && syft . -o json > sbom.json

      - name: Grype
        run: curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin && grype sbom:sbom.json

      - name: OWASP ZAP Baseline
        run: docker run --rm -v $(pwd):/zap/wrk:rw ghcr.io/zaproxy/zaproxy zap-baseline.py -t http://example.com -r zap.html -m 10
